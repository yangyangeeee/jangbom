{% load humanize %}

<a href="javascript:history.back()">â—</a>
<a href="{% url 'food:cart_view' %}">ğŸ§º
        {% if cart_items_count == 0 %}
        {% else %}
            {{ cart_items_count }}
        {% endif %}
    </a>
    <a href="{% url 'point:barcode' %}">ë°”ì½”ë“œ</a>
    {{ total_point }}P

<h2>ì„¸ë¶€ í™œë™ ë‚´ì—­</h2>

<!-- ê²€ìƒ‰ í¼ -->
<form method="get" action="">
    <input type="hidden" name="period" value="{{ period }}">
    <input type="hidden" name="sort" value="{{ sort }}">
    <input type="text" name="q" value="{{ q|default:'' }}" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
    <button type="submit">ê²€ìƒ‰</button>
    <a href="?">ì´ˆê¸°í™”</a>
</form>

<!-- í•„í„° í¼ -->
<form method="get" action="">
    <input type="hidden" name="q" value="{{ q }}">
    <select name="period" onchange="this.form.submit()">
        <option value="1m" {% if period == '1m' %}selected{% endif %}>ìµœê·¼ 1ê°œì›”</option>
        <option value="3m" {% if period == '3m' %}selected{% endif %}>ìµœê·¼ 3ê°œì›”</option>
        <option value="6m" {% if period == '6m' %}selected{% endif %}>ìµœê·¼ 6ê°œì›”</option>
        <option value="1y" {% if period == '1y' %}selected{% endif %}>ìµœê·¼ 1ë…„</option>
        <option value="all" {% if period == 'all' %}selected{% endif %}>ì „ì²´</option>
    </select>
    <label>
        <input type="radio" name="sort" value="latest" onchange="this.form.submit()" {% if sort == 'latest' %}checked{% endif %}> ìµœì‹ ìˆœ
    </label>
    <label>
        <input type="radio" name="sort" value="points" onchange="this.form.submit()" {% if sort == 'points' %}checked{% endif %}> í¬ì¸íŠ¸ìˆœ
    </label>
</form>

<!-- ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ -->
{% if log_data %}
    <div id="activity-list">
        {% for log in log_data %}
        <div class="activity-item" data-id="{{ log.shopping_list_id }}">
            <div class="activity-header">
            <span class="toggle" aria-hidden="true">â–¶</span>
            <strong>{{ log.market_name }}</strong>
            <span> â€” {{ log.visited_at|date:"Y.m.d H:i" }}</span>
            </div>
            <div class="detail-box" id="detail-{{ log.shopping_list_id }}" style="display:none;"></div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <p>í•´ë‹¹ ì¡°ê±´ì˜ í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Django URL ë¦¬ë²„ìŠ¤ ì‚¬ìš© (0ì„ ìë¦¬í‘œì‹œìë¡œ ë‘ê³  JSì—ì„œ ì¹˜í™˜)
    const ajaxPattern = "{% url 'accounts:activity_detail_ajax' 0 %}".replace('0', '__ID__');

    document.querySelectorAll('.activity-item .activity-header').forEach(function (header) {
        header.addEventListener('click', function () {
        const item = this.closest('.activity-item');
        const id = item.dataset.id;
        const box = item.querySelector('.detail-box');
        const icon = this.querySelector('.toggle');

        if (box.style.display === 'block') {
            // ë‹«ê¸°
            box.style.display = 'none';
            icon.textContent = 'â–¶';
            return;
        }

        // ì²˜ìŒ ì—´ ë•Œë§Œ fetch
        if (!box.dataset.loaded) {
            fetch(ajaxPattern.replace('__ID__', id))
            .then(function (res) { return res.json(); })
            .then(function (data) {
                box.innerHTML = `
                <h4>ê±·ê¸° ê¸°ë¡</h4>
                <p>íšë“ í¬ì¸íŠ¸: +${data.point_earned}P</p>
                <p>ì´ë™ ì‹œê°„: ${data.travel_minutes} ë¶„</p>
                <p>ê±¸ìŒ ìˆ˜: ${data.steps} ê±¸ìŒ</p>
                <p>ì†Œëª¨ ì¹¼ë¡œë¦¬: ${data.calories_kcal} kcal</p>
                <h4>êµ¬ë§¤í•œ ì‹ì¬ë£Œ</h4>
                <ul>${(data.ingredients || []).map(function(i){ return `<li>${i}</li>`; }).join('')}</ul>
                `;
                box.dataset.loaded = '1';
                box.style.display = 'block';
                icon.textContent = 'â–¼';
            });
        } else {
            // ì´ë¯¸ ë¶ˆëŸ¬ì™”ìœ¼ë©´ ê·¸ëƒ¥ ì—´ê¸°
            box.style.display = 'block';
            icon.textContent = 'â–¼';
        }
        });
    });
});
</script>
