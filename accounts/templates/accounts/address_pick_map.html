<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ì§€ë„ì—ì„œ ìœ„ì¹˜ í™•ì¸</title>
  {% if kakao_js_key %}
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}&libraries=services"></script>
  {% endif %}
</head>
<body>
  <a href="{% url 'accounts:address_settings' %}">â†</a>
  <h1>ì§€ë„ì—ì„œ ìœ„ì¹˜ í™•ì¸</h1>

  <!-- ì§€ë„ -->
  <div id="map" style="width:100%;height:360px;"></div>

  <!-- í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™ ë²„íŠ¼ -->
  <button type="button" id="btn-geolocate">ğŸ¯</button>

  <!-- ì£¼ì†Œ ë…¸ì¶œ -->
  <div>
    <h3 id="addr-title"></h3>
  </div>

  <!-- addr_level ë¶€ë¶„ì€ íˆë“  ì²˜ë¦¬ -->
  <div style="display:none">
    <p id="addr-sub"></p>
  </div>

  <!-- ì´ ìœ„ì¹˜ë¡œ ë“±ë¡ -->
  <form id="save-direct" method="post" action="{% url 'accounts:address_save_from_map' %}">
    {% csrf_token %}
    <input type="hidden" name="name" id="f-name">
    <input type="hidden" name="l1"   id="f-l1">
    <input type="hidden" name="l2"   id="f-l2">
    <input type="hidden" name="l3"   id="f-l3">
    <input type="hidden" name="lat"  id="f-lat">
    <input type="hidden" name="lng"  id="f-lng">
    ìƒì„¸ ì£¼ì†Œ <input type="text" name="detail"> <br>
    <p style="color:#d33">ì§€ë„ì˜ í‘œì‹œì™€ ì‹¤ì œ ì£¼ì†Œê°€ ë§ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”</p>
    <button type="submit">ì´ ìœ„ì¹˜ë¡œ ì£¼ì†Œ ë“±ë¡</button>
  </form>

<script>
(function(){
  var initLat = parseFloat("{{ init_lat }}");
  var initLng = parseFloat("{{ init_lng }}");

  if (!window.kakao || !kakao.maps) {
    alert("ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    return;
  }

  var map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(initLat, initLng),
    level: 3
  });

  var geocoder = new kakao.maps.services.Geocoder();
  var marker = new kakao.maps.Marker({ position: map.getCenter(), draggable: false });
  marker.setMap(map);

  function updateCenterInfo() {
    var center = map.getCenter();
    marker.setPosition(center);

    var lat = center.getLat(), lng = center.getLng();
    document.getElementById('f-lat').value = lat.toFixed(6);
    document.getElementById('f-lng').value = lng.toFixed(6);

    geocoder.coord2Address(lng, lat, function(result, status){
      if (status !== kakao.maps.services.Status.OK || !result || !result.length){
        document.getElementById('addr-title').textContent = "ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤";
        document.getElementById('addr-sub').textContent = "";
        document.getElementById('f-name').value = "";
        document.getElementById('f-l1').value = "";
        document.getElementById('f-l2').value = "";
        document.getElementById('f-l3').value = "";
        return;
      }
      var r = result[0];
      var road = r.road_address;
      var jibun = r.address;

      var name = (road && road.address_name) || (jibun && jibun.address_name) || "";
      var l1 = (road && road.region_1depth_name) || (jibun && jibun.region_1depth_name) || "";
      var l2 = (road && road.region_2depth_name) || (jibun && jibun.region_2depth_name) || "";
      var l3 = (road && road.region_3depth_name) || (jibun && jibun.region_3depth_name) || "";

      document.getElementById('addr-title').textContent = name || "ì£¼ì†Œ ë¯¸í™•ì¸";
      document.getElementById('addr-sub').textContent   = (l1 + " " + l2 + " " + l3).trim();

      document.getElementById('f-name').value = name;
      document.getElementById('f-l1').value = l1;
      document.getElementById('f-l2').value = l2;
      document.getElementById('f-l3').value = l3;
    });
  }

  kakao.maps.event.addListener(map, 'idle', updateCenterInfo);
  updateCenterInfo();

  function getCurrent(){
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(function(pos){
      var lat = pos.coords.latitude;
      var lng = pos.coords.longitude;
      map.setCenter(new kakao.maps.LatLng(lat, lng)); // idleì—ì„œ updateCenterInfo ì‹¤í–‰
    }, function(err){
      console.warn("geolocation error:", err);
    }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 });
  }

  // âœ… í˜ì´ì§€ ì§„ì… ì¦‰ì‹œ í˜„ì¬ ìœ„ì¹˜ ì‹œë„(ê¶Œí•œ ì°½ ìë™ í‘œì‹œ)
  (function autoLocate(){
    if (!navigator.geolocation) return;
    if (navigator.permissions && navigator.permissions.query) {
      navigator.permissions.query({ name: 'geolocation' })
        .then(function(p){
          if (p.state === 'granted' || p.state === 'prompt') getCurrent();
        })
        .catch(getCurrent);
    } else {
      getCurrent();
    }
  })();

  // ìˆ˜ë™ ë²„íŠ¼
  var btn = document.getElementById('btn-geolocate');
  if (btn) btn.addEventListener('click', function(){ getCurrent(); });

  // ì§€ë„ í´ë¦­ìœ¼ë¡œë„ ìœ„ì¹˜ ì„ íƒ ê°€ëŠ¥(ì›í•˜ë©´ ìœ ì§€)
  kakao.maps.event.addListener(map, 'click', function(e){
    map.setCenter(e.latLng);
  });
})();
</script>
</body>
</html>
