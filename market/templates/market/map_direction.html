<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ market.name }}ë¡œ ê°€ëŠ” ê¸¸</title>
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_key }}&autoload=true"></script>
</head>
<body>
<!--ìƒë‹¨ë°”-->
<a href="javascript:history.back()">â—</a>
<a href="{% url 'food:cart_view' %}">ğŸ§º
    {% if cart_items_count == 0 %}
        {% else %}
            {{ cart_items_count }}
        {% endif %}
    </a>
    ë°”ì½”ë“œ
    {{ total_point }}P


  <h2>-------------{{ expected_time }}ë¶„ ì˜ˆìƒ-------------</h2>
    <h3>{{ market.name }}ë¡œ ê±¸ì–´ê°€ëŠ” ì¤‘</h3>

    <div id="map" style="width:100%; height:400px;"></div>


<script>
  // Djangoì—ì„œ json.dumpsë¡œ ë„£ì€ ê·¸ëŒ€ë¡œ JS ê°ì²´ë¡œ ë“¤ì–´ì˜´
  const polylinePoints = {{ polyline|safe }};
  console.log("Polyline points:", polylinePoints);

  if (!Array.isArray(polylinePoints) || polylinePoints.length === 0) {
    alert("ë„ë³´ ê²½ë¡œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }

  // Kakao Map ì¤€ë¹„
  const mapContainer = document.getElementById('map');

  // ê²½ë¡œê°€ ìˆìœ¼ë©´ ì²« ì , ì—†ìœ¼ë©´ ë§ˆì¼“ ì¢Œí‘œë¡œ ì„¼í„°
  const centerLat = polylinePoints.length ? polylinePoints[0].lat : {{ market.latitude }};
  const centerLng = polylinePoints.length ? polylinePoints[0].lng : {{ market.longitude }};

  const map = new kakao.maps.Map(mapContainer, {
    center: new kakao.maps.LatLng(centerLat, centerLng),
    level: 5
  });

  // â˜… ì—¬ê¸°! [{lat, lng}] â†’ kakao.maps.LatLng(lat, lng)
  const path = polylinePoints.map(p => new kakao.maps.LatLng(p.lat, p.lng));

  // í´ë¦¬ë¼ì¸
  const polylineLine = new kakao.maps.Polyline({
    path: path,
    strokeWeight: 5,
    strokeColor: '#1E90FF',
    strokeOpacity: 0.9,
    strokeStyle: 'solid'
  });
  polylineLine.setMap(map);

  // ê²½ë¡œ ì „ì²´ê°€ ë³´ì´ë„ë¡ bounds ë§ì¶”ê¸°(ì¶”ì²œ)
  if (path.length > 1) {
    const bounds = new kakao.maps.LatLngBounds();
    path.forEach(pt => bounds.extend(pt));
    map.setBounds(bounds);
  }

  // ì¶œë°œ/ë„ì°© ë§ˆì»¤
  if (path.length) {
    new kakao.maps.Marker({ position: path[0], map, title: "ì¶œë°œì§€" });
    new kakao.maps.Marker({ position: path[path.length - 1], map, title: "ë„ì°©ì§€" });
  }
</script>


    <br>

    <!--ì—…ì²´ ì •ë³´-->
    {% if market and market.market_type|lower == 'mart' %}
    <br><hr>
    <h3>ì—…ì²´ ì •ë³´</h3>

    {% if closing_in_minutes > 0 %}
        {% if closing_in_minutes <= 30 %}
        <p>ì˜ì—… ì¢…ë£Œê¹Œì§€ {{ closing_in_minutes }}ë¶„ ë‚¨ì•˜ì–´ìš”.</p>
        {% else %}
        <p>í˜„ì¬ ì˜ì—… ì¤‘</p>
        {% endif %}
    {% else %}
        <p>ì˜ì—… ì¢…ë£Œ</p>
    {% endif %}

    <p>{{ market.info }}</p>
    <p>{{ market.phone }}</p>
    <p>{{ market.address }}</p>
{% endif %}

    <!--ì¥ë°”êµ¬ë‹ˆ--> <br><hr>
    <h3>ì¥ë°”êµ¬ë‹ˆ</h3>

    {% if market.market_type == 'mart' %}
    <div class="ingredient-list">
        {% for item in matched_ingredients %}
        <div class="ingredient-box">
            {% if item.image %}
            <img src="{{ item.image }}" alt="{{ item.name }}" style="width:50px;height:50px;object-fit:cover;margin-right:10px;">
            {% else %}
            <div class="no-img-box"></div>
            {% endif %}
            <div>{{ item.name }}</div>
        </div>
        {% empty %}
        <p>ì¥ë°”êµ¬ë‹ˆì— ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
    </div>

    {% if unmatched_ingredients %}
    <p>
        {% for item in unmatched_ingredients %}
        <span class="pill">{{ item.name }}</span>
        {% endfor %}
        ì€(ëŠ”) í•´ë‹¹ ë§ˆíŠ¸ì—ì„œ íŒë§¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </p>
    {% endif %}

    {% elif market.market_type == 'trad' %}
    <div class="ingredient-list">
        {% for item in unmatched_ingredients %}
        <div class="ingredient-box">
            {% if item.image %}
            <img src="{{ item.image }}" alt="{{ item.name }}"
                style="width:50px;height:50px;object-fit:cover;margin-right:10px;">
            {% else %}
            <div class="no-img-box"></div>
            {% endif %}
            <div>{{ item.name }}</div>
        </div>
        {% empty %}
        <p>ì¥ë°”êµ¬ë‹ˆì— ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
    </div>
    {% endif %}
    <br>


<br><hr><br>
{% if market.market_type == 'mart' %}
    <button onclick="window.location.href='tel:{{ market.phone }}'">ì „í™” ê±¸ê¸°</button>
    <button>ì±„íŒ… í•˜ê¸°</button>
{% else %}
{% endif %}
    <p>{{ point_earned }} í¬ì¸íŠ¸ ì ë¦½</p>

<form method="get" action="{% url 'market:market_arrival' shopping_list.id %}">
    <button type="submit">ë„ì°© í™•ì¸</button>
</form>

</body>
</html>
