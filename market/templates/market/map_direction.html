
{% load static %}
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <link rel="stylesheet" href="{% static 'css/map_direction.css' %}" />
    <title>{{ market.name }}로 가는 길</title>

    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_key }}&autoload=false"></script>

  </head>
  <body>
    <div class="container">
      <div class="box">
        {% comment %} 상단바 {% endcomment %}
        <div class="status-bar">
          <p>19:20</p>
          <div class="status1">
            <img class="status2" src="{% static 'img/reception.svg' %}" alt="reception" />
            <img class="status2" src="{% static 'img/wifi.svg' %}" alt="wifi" />
            <img class="status2" src="{% static 'img/battery.svg' %}" alt="battery" />
          </div>
        </div>

        {% comment %} 앱 자체 상단바 {% endcomment %}
        <div class="app-top-bar">
          <a href="javascript:history.back()" aria-label="뒤로가기">
            <img class="top-back" src="{% static 'img/chevron-left.svg' %}" alt="뒤로가기" />
          </a>

          <div class="top-point">
            <a class="top-cart" href="{% url 'food:cart_view' %}" aria-label="장바구니">
              🧺{% if cart_items_count %}<span class="cart-count">{{ cart_items_count }}</span>{% endif %}
            </a>
            <img class="point" src="{% static 'img/lucide.svg' %}" alt="point" />
            <p class="mypoint">{{ total_point }} P</p>
          </div>
        </div>

        <main class="app-body">
          <div class="moving">
            <div class="circle-wrap">
              <div class="middle-line"></div>
              <div class="circle-time">
                <span class="runner-time">{{ expected_time }}분</span>
                <p>예상</p>
              </div>
              <img class="tree2" src="{% static 'img/tree2.svg' %}" alt="tree" />
            </div>
            <h4 class="moving-status">{{ market.name }}(으)로 걸어가는 중</h4>
          </div>

          <div id="map" class="mart-loc" style="width:100%; height:260px;"></div>

          <div class="app-bottom-bar">
            <div class="bar-content">
              <div class="bar-list">
                <div class="mart-dropdown">
                  <div class="bar-title">
                    업체 정보
                    <img class="more-icon" src="{% static 'img/chevron-down.svg' %}" alt="more" />
                  </div>
                  <div class="mart-info">
                    <label class="mi-item">
                      <img src="{% static 'img/clock.svg' %}" alt="영업" />
                      <span class="mi-name">
                        {% if closing_in_minutes and closing_in_minutes > 0 %}
                          {% if closing_in_minutes <= 30 %}
                            영업 종료까지 {{ closing_in_minutes }}분 남았어요.
                          {% else %}
                            현재 영업 중
                          {% endif %}
                        {% else %}
                          영업 종료
                        {% endif %}
                      </span>
                    </label>

                    {% if market.info %}
                    <label class="mi-item">
                      <img src="{% static 'img/store.svg' %}" alt="정보" />
                      <span class="mi-name">{{ market.info }}</span>
                    </label>
                    {% endif %}

                    {% if market.phone %}
                    <label class="mi-item">
                      <img src="{% static 'img/phone.svg' %}" alt="전화" />
                      <span class="mi-name">{{ market.phone }}</span>
                    </label>
                    {% endif %}

                    {% if market.address %}
                    <label class="mi-item">
                      <img src="{% static 'img/map-pin.svg' %}" alt="주소" />
                      <span class="mi-name">{{ market.address }}</span>
                    </label>
                    {% endif %}
                  </div>
                </div>

                <div class="mart-dropdown">
                  <div class="bar-title">
                    장바구니
                    <img class="more-icon" src="{% static 'img/chevron-down.svg' %}" alt="more" />
                  </div>

                  <div class="mat-block-set">
                    <div class="item-grid">
                      {% if market.market_type|lower == 'mart' %}
                        {% for item in matched_ingredients %}
                        <div class="item">
                          {% if item.image %}
                            <img class="item-pic" src="{{ item.image }}" alt="{{ item.name }}" />
                          {% else %}
                            <div class="item-pic"></div>
                          {% endif %}
                          {{ item.name }}
                        </div>
                        {% empty %}
                          <p>장바구니에 재료가 없습니다.</p>
                        {% endfor %}
                      {% elif market.market_type|lower == 'trad' %}
                        {% for item in unmatched_ingredients %}
                        <div class="item">
                          {% if item.image %}
                            <img class="item-pic" src="{{ item.image }}" alt="{{ item.name }}" />
                          {% else %}
                            <div class="item-pic"></div>
                          {% endif %}
                          {{ item.name }}
                        </div>
                        {% empty %}
                          <p>장바구니에 재료가 없습니다.</p>
                        {% endfor %}
                      {% else %}
                        <p>장바구니 정보를 불러올 수 없습니다.</p>
                      {% endif %}
                    </div>

                    {% if market.market_type|lower == 'mart' and unmatched_ingredients %}
                    <p class="unmatched-note">
                      {% for item in unmatched_ingredients %}
                        <span class="pill">{{ item.name }}</span>
                      {% endfor %}
                      은(는) 해당 마트에서 판매하지 않습니다.
                    </p>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="bar-buttons">
                {% if market.market_type|lower == 'mart' and market.phone %}
                  <a class="barBtn" href="tel:{{ market.phone }}">전화걸기</a>
                {% else %}
                  <button class="barBtn" disabled aria-disabled="true" title="전화 불가">전화걸기</button>
                {% endif %}
                <button class="barBtn">채팅하기</button>
              </div>
            </div>
          </div>
        </main>

        <footer class="start">
          <span class="start-point">
            <img src="{% static 'img/coins.svg' %}" alt="coin" /> {{ point_earned }} 포인트 적립
          </span>
          <form method="get" action="{% url 'market:market_arrival' shopping_list.id %}">
            <button type="submit" class="startBtn">도착 확인</button>
          </form>
        </footer>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        kakao.maps.load(function () {
          const polylinePoints = {{ polyline|safe }};
          const mapContainer = document.getElementById('map');

          const centerLat = (Array.isArray(polylinePoints) && polylinePoints.length)
            ? polylinePoints[0].lat : {{ market.latitude|default:"37.5665" }};
          const centerLng = (Array.isArray(polylinePoints) && polylinePoints.length)
            ? polylinePoints[0].lng : {{ market.longitude|default:"126.9780" }};

          const map = new kakao.maps.Map(mapContainer, {
            center: new kakao.maps.LatLng(centerLat, centerLng),
            level: 5
          });

          if (!Array.isArray(polylinePoints) || polylinePoints.length === 0) {
            const dst = new kakao.maps.LatLng({{ market.latitude|default:"37.5665" }}, {{ market.longitude|default:"126.9780" }});
            new kakao.maps.Marker({ position: dst, map, title: "{{ market.name }}" });
            return;
          }

          const path = polylinePoints.map(p => new kakao.maps.LatLng(p.lat, p.lng));

          const polylineLine = new kakao.maps.Polyline({
            path: path,
            strokeWeight: 5,
            strokeColor: '#1E90FF',
            strokeOpacity: 0.9,
            strokeStyle: 'solid'
          });
          polylineLine.setMap(map);

          if (path.length > 1) {
            const bounds = new kakao.maps.LatLngBounds();
            path.forEach(pt => bounds.extend(pt));
            map.setBounds(bounds);
          }

          new kakao.maps.Marker({ position: path[0], map, title: "출발지" });
          new kakao.maps.Marker({ position: path[path.length - 1], map, title: "도착지" });
        });
      });
    </script>
    <script src="{% static 'js/map_direction.js' %}" defer></script>
  </body>
</html>
