{% load static %}
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <link rel="stylesheet" href="{% static 'css/map_direction.css' %}" />
    <title>{{ market.name }}ë¡œ ê°€ëŠ” ê¸¸</title>

    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_key }}&autoload=false"></script>

  </head>
  <body>
    <div class="container">
      <div class="box">
        {% comment %} ìƒë‹¨ë°” {% endcomment %}
        <div class="status-bar">
          <p>19:20</p>
          <div class="status1">
            <img class="status2" src="{% static 'img/reception.svg' %}" alt="reception" />
            <img class="status2" src="{% static 'img/wifi.svg' %}" alt="wifi" />
            <img class="status2" src="{% static 'img/battery.svg' %}" alt="battery" />
          </div>
        </div>

        {% comment %} ì•± ìì²´ ìƒë‹¨ë°” {% endcomment %}
        <div class="app-top-bar">
          <a href="javascript:history.back()" aria-label="ë’¤ë¡œê°€ê¸°">
            <img class="top-back" src="{% static 'img/chevron-left.svg' %}" alt="ë’¤ë¡œê°€ê¸°" />
          </a>

          <div class="top-point">
            <a class="top-cart" href="{% url 'food:cart_view' %}" aria-label="ì¥ë°”êµ¬ë‹ˆ">
              ğŸ§º{% if cart_items_count %}<span class="cart-count">{{ cart_items_count }}</span>{% endif %}
            </a>
            <img class="point" src="{% static 'img/lucide.svg' %}" alt="point" />
            <p class="mypoint">{{ total_point }} P</p>
          </div>
        </div>

        <main class="app-body">
          <div class="moving">
            <div class="circle-wrap">
              <div class="middle-line"></div>
              <div class="circle-time">
                <span class="runner-time">{{ expected_time }}ë¶„</span>
                <p>ì˜ˆìƒ</p>
              </div>
              <img class="tree2" src="{% static 'img/tree2.svg' %}" alt="tree" />
            </div>
            <h4 class="moving-status">{{ market.name }}(ìœ¼)ë¡œ ê±¸ì–´ê°€ëŠ” ì¤‘</h4>
          </div>

          <div id="map" class="mart-loc" style="width:100%; height:260px;"></div>

          <div class="app-bottom-bar">
            <div class="bar-content">
              <div class="bar-list">
                <div class="mart-dropdown">
                  <div class="bar-title">
                    ì—…ì²´ ì •ë³´
                    <img class="more-icon" src="{% static 'img/chevron-down.svg' %}" alt="more" />
                  </div>
                  <div class="mart-info">
                    <label class="mi-item">
                      <img src="{% static 'img/clock.svg' %}" alt="ì˜ì—…" />
                      <span class="mi-name">
                        {% if closing_in_minutes and closing_in_minutes > 0 %}
                          {% if closing_in_minutes <= 30 %}
                            ì˜ì—… ì¢…ë£Œê¹Œì§€ {{ closing_in_minutes }}ë¶„ ë‚¨ì•˜ì–´ìš”.
                          {% else %}
                            í˜„ì¬ ì˜ì—… ì¤‘
                          {% endif %}
                        {% else %}
                          ì˜ì—… ì¢…ë£Œ
                        {% endif %}
                      </span>
                    </label>

                    {% if market.info %}
                    <label class="mi-item">
                      <img src="{% static 'img/store.svg' %}" alt="ì •ë³´" />
                      <span class="mi-name">{{ market.info }}</span>
                    </label>
                    {% endif %}

                    {% if market.phone %}
                    <label class="mi-item">
                      <img src="{% static 'img/phone.svg' %}" alt="ì „í™”" />
                      <span class="mi-name">{{ market.phone }}</span>
                    </label>
                    {% endif %}

                    {% if market.address %}
                    <label class="mi-item">
                      <img src="{% static 'img/map-pin.svg' %}" alt="ì£¼ì†Œ" />
                      <span class="mi-name">{{ market.address }}</span>
                    </label>
                    {% endif %}
                  </div>
                </div>

                <div class="mart-dropdown">
                  <div class="bar-title">
                    ì¥ë°”êµ¬ë‹ˆ
                    <img class="more-icon" src="{% static 'img/chevron-down.svg' %}" alt="more" />
                  </div>

                  <div class="mat-block-set">
                    <div class="item-grid">
                      {% if market.market_type|lower == 'mart' %}
                        {% for item in matched_ingredients %}
                        <div class="item">
                          {% if item.image %}
                            <img class="item-pic" src="{{ item.image }}" alt="{{ item.name }}" />
                          {% else %}
                            <div class="item-pic"></div>
                          {% endif %}
                          {{ item.name }}
                        </div>
                        {% empty %}
                          <p>ì¥ë°”êµ¬ë‹ˆì— ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endfor %}
                      {% elif market.market_type|lower == 'trad' %}
                        {% for item in unmatched_ingredients %}
                        <div class="item">
                          {% if item.image %}
                            <img class="item-pic" src="{{ item.image }}" alt="{{ item.name }}" />
                          {% else %}
                            <div class="item-pic"></div>
                          {% endif %}
                          {{ item.name }}
                        </div>
                        {% empty %}
                          <p>ì¥ë°”êµ¬ë‹ˆì— ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endfor %}
                      {% else %}
                        <p>ì¥ë°”êµ¬ë‹ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                      {% endif %}
                    </div>

                    {% if market.market_type|lower == 'mart' and unmatched_ingredients %}
                    <p class="unmatched-note">
                      {% for item in unmatched_ingredients %}
                        <span class="pill">{{ item.name }}</span>
                      {% endfor %}
                      ì€(ëŠ”) í•´ë‹¹ ë§ˆíŠ¸ì—ì„œ íŒë§¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </p>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="bar-buttons">
                {% if market.market_type|lower == 'mart' and market.phone %}
                  <a class="barBtn" href="tel:{{ market.phone }}">ì „í™”ê±¸ê¸°</a>
                {% else %}
                  <button class="barBtn" disabled aria-disabled="true" title="ì „í™” ë¶ˆê°€">ì „í™”ê±¸ê¸°</button>
                {% endif %}
                <button class="barBtn">ì±„íŒ…í•˜ê¸°</button>
              </div>
            </div>
          </div>
        </main>

        <footer class="start">
          <span class="start-point">
            <img src="{% static 'img/coins.svg' %}" alt="coin" /> {{ point_earned }} í¬ì¸íŠ¸ ì ë¦½
          </span>
          <form method="get" action="{% url 'market:market_arrival' shopping_list.id %}">
            <button type="submit" class="startBtn">ë„ì°© í™•ì¸</button>
          </form>
        </footer>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        kakao.maps.load(function () {
          const polylinePoints = {{ polyline|safe }};
          const mapContainer = document.getElementById('map');

          const centerLat = (Array.isArray(polylinePoints) && polylinePoints.length)
            ? polylinePoints[0].lat : {{ market.latitude|default:"37.5665" }};
          const centerLng = (Array.isArray(polylinePoints) && polylinePoints.length)
            ? polylinePoints[0].lng : {{ market.longitude|default:"126.9780" }};

          const map = new kakao.maps.Map(mapContainer, {
            center: new kakao.maps.LatLng(centerLat, centerLng),
            level: 5
          });

          if (!Array.isArray(polylinePoints) || polylinePoints.length === 0) {
            const dst = new kakao.maps.LatLng({{ market.latitude|default:"37.5665" }}, {{ market.longitude|default:"126.9780" }});
            new kakao.maps.Marker({ position: dst, map, title: "{{ market.name }}" });
            return;
          }

          const path = polylinePoints.map(p => new kakao.maps.LatLng(p.lat, p.lng));

          const polylineLine = new kakao.maps.Polyline({
            path: path,
            strokeWeight: 5,
            strokeColor: '#1E90FF',
            strokeOpacity: 0.9,
            strokeStyle: 'solid'
          });
          polylineLine.setMap(map);

          if (path.length > 1) {
            const bounds = new kakao.maps.LatLngBounds();
            path.forEach(pt => bounds.extend(pt));
            map.setBounds(bounds);
          }

          new kakao.maps.Marker({ position: path[0], map, title: "ì¶œë°œì§€" });
          new kakao.maps.Marker({ position: path[path.length - 1], map, title: "ë„ì°©ì§€" });
        });
      });
    </script>
    <script src="{% static 'js/map_direction.js' %}" defer></script>
  </body>
</html>
