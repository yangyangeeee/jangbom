{% load static %}
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <link rel="stylesheet" href="{% static 'css/shopping_success.css' %}" />
    <title>shopping_success(ë„ì°©)</title>
  </head>
  <body>
    <div class="container">
      <div class="box">
        {% comment %} ìƒë‹¨ë°” {% endcomment %}
        <div class="status-bar">
          <p>19:20</p>
          <div class="status1">
            <img class="status2" src="{% static 'img/reception.svg' %}" alt="reception" />
            <img class="status2" src="{% static 'img/wifi.svg' %}" alt="wifi" />
            <img class="status2" src="{% static 'img/battery.svg' %}" alt="battery" />
          </div>
        </div>

        {% comment %} ì•± ìì²´ ìƒë‹¨ë°” {% endcomment %}
        <div class="app-top-bar">
          <a class="top-back" href="javascript:history.back()" aria-label="ë’¤ë¡œê°€ê¸°">
            <img src="{% static 'img/chevron-left.svg' %}" alt="back" />
          </a>
          <div class="top-point">
            <a
              href="{% url 'food:cart_view' %}"
              class="cart-link"
              aria-label="ì¥ë°”êµ¬ë‹ˆ"
              style="margin-left: 8px"
            >
              ğŸ§º{% if cart_items_count %}<span class="cart-badge"
                >{{ cart_items_count }}</span
              >{% endif %}
            </a>
            <img class="point" src="{% static 'img/lucide.svg' %}" alt="point" />
            <p class="mypoint">{{ total_point|default:"0" }} P</p>
          </div>
        </div>

        <main class="app-body">
          <div class="point-saving">
            <img src="{% static 'img/ë°•.svg' %}" alt="" />
            <span class="start-point">
              <img src="{% static 'img/coins.svg' %}" alt="" />
              {% if message %}
                {{ message }}
              {% else %}
                {{ point_earned|default:"0" }} í¬ì¸íŠ¸ ì ë¦½!
              {% endif %}
            </span>

            <div class="total-point">
              <p>ëˆ„ì  í¬ì¸íŠ¸</p>
              <p>{{ total_point|default:"0" }}P</p>
            </div>
            <div class="total-runtime">
              <p>ëˆ„ì  ê±¸ìŒ ì‹œê°„</p>
              <p>
                {% if total_runtime %}{{ total_runtime }}
                {% elif total_steps %}{{ total_steps }}
                {% else %}0{% endif %}
              </p>
            </div>

            <div class="goto-myactivity">
              <a class="saving-history-set" href="{% url 'point:point_history' %}">
                <img class="set-img" src="{% static 'img/ëˆì£¼ë¨¸ë‹ˆ.svg' %}" alt="ì ë¦½ë‚´ì—­" />
                <div class="saving-history">
                  ì ë¦½ë‚´ì—­
                  <img src="{% static 'img/chevron-right(gray).svg' %}" alt="" />
                </div>
              </a>
              <a class="check-ranking-set" href="{% url 'point:point_ranking' %}">
                <img class="set-img" src="{% static 'img/í›ˆì¥.svg' %}" alt="ë­í‚¹í™•ì¸" />
                <div class="check-ranking">
                  ë­í‚¹í™•ì¸
                  <img src="{% static 'img/chevron-right(gray).svg' %}" alt="" />
                </div>
              </a>
            </div>
          </div>

          <div class="rec-more-place" data-market-id="{{ market.id }}">
            <div class="rec-header">
              <h3>ì£¼ë³€ì— ì´ëŸ° ì¥ì†Œë„ ìˆì–´ìš”</h3>
              <button class="rec-refresh" id="nearby-refresh" type="button" aria-label="ìƒˆë¡œê³ ì¹¨">
                <img src="{% static 'img/rotate-ccw.svg' %}" alt="ìƒˆë¡œê³ ì¹¨" />
              </button>
            </div>

            <div id="nearby-empty" {% if nearby_places %}hidden{% endif %}>
              ë“±ë¡ëœ ì£¼ë³€ ì¥ì†Œê°€ ì—†ì–´ìš”.
            </div>

            <div class="rec-more-place-list" id="nearby-list">
              {% for p in nearby_places %}
              <div class="rec-more-place-item">
                {% if p.image %}
                  <img src="{{ p.image.url }}" alt="ì¶”ì²œ ì¥ì†Œ" />
                {% else %}
                  <img src="{% static 'img/rec-placeholder.svg' %}" alt="ì¶”ì²œ ì¥ì†Œ" />
                {% endif %}
                <div class="about-place">
                  <div class="rec-place">
                    <span class="rec-place-name">{{ p.name }}</span>
                    {% if p.category %}
                      <span class="market-sort">{{ p.category }}</span>
                    {% endif %}
                  </div>
                  <div class="rec-place-detail">
                    <p>{{ p.info }}</p>
                    <div class="rec-place-more">
                      <p>ì˜ì—…ì¤‘</p>
                      <p>{{ p.distance_m }}m</p>
                      {% if p.link_url %}
                        <a class="more-btn" href="{{ p.link_url }}" target="_blank" rel="noopener">ë”ë³´ê¸°</a>
                      {% else %}
                        <button class="more-btn" type="button" disabled>ë”ë³´ê¸°</button>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </main>

        {% comment %} ì•± ìì²´ í•˜ë‹¨ë°” {% endcomment %}
        <nav class="bottom-nav">
          <a class="bottom-nav-item" href="{% url 'food:main' %}">
            <img src="{% static 'img/house.svg' %}" alt="í™ˆ" />
            <span class="bottom-nav-item-title">í™ˆ</span>
          </a>
          <a class="bottom-nav-item" href="{% url 'accounts:activity_log' %}">
            <img src="{% static 'img/footprints.svg' %}" alt="ë‚´ í™œë™" />
            <span class="bottom-nav-item-title">ë‚´ í™œë™</span>
          </a>
          <a class="bottom-nav-item" href="{% url 'point:point_home' %}">
            <img src="{% static 'img/circle-parking.svg' %}" alt="í¬ì¸íŠ¸" />
            <span class="bottom-nav-item-title">í¬ì¸íŠ¸</span>
          </a>
        </nav>
      </div>
    </div>

    <script>
      (function () {
        const btn = document.getElementById('nearby-refresh');
        if (!btn) return;

        async function refreshNearby() {
          const marketId = document.querySelector('.rec-more-place')?.dataset?.marketId;
          if (!marketId) return;

          try {
            const res = await fetch("{% url 'market:nearby_random' market.id %}");
            if (!res.ok) {
              const text = await res.text();
              console.error("HTTP", res.status, text);
              alert("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: " + res.status);
              return;
            }

            const data = await res.json();
            const list = document.getElementById('nearby-list');
            const empty = document.getElementById('nearby-empty');
            list.innerHTML = "";

            if (!data.ok || !data.items || data.items.length === 0) {
              empty.hidden = false;
              return;
            }
            empty.hidden = true;

            for (const p of data.items) {
              const item = document.createElement('div');
              item.className = 'rec-more-place-item';
              item.innerHTML = `
                ${p.image_url
                  ? `<img src="${p.image_url}" alt="ì¶”ì²œ ì¥ì†Œ" />`
                  : `<img src="{% static 'img/rec-placeholder.svg' %}" alt="ì¶”ì²œ ì¥ì†Œ" />`
                }
                <div class="about-place">
                  <div class="rec-place">
                    <span class="rec-place-name">${p.name ?? ""}</span>
                    ${p.category ? `<span class="market-sort">${p.category}</span>` : ""}
                  </div>
                  <div class="rec-place-detail">
                    <p>${p.info ?? ""}</p>
                    <div class="rec-place-more">
                      <p>ì˜ì—…ì¤‘${p.closing_in_minutes ? ` Â· ${p.closing_in_minutes}ë¶„ ë‚¨ìŒ` : ""}</p>
                      <p>${p.distance_m ?? ""}m</p>
                      ${p.link_url ? `<a class="more-btn" href="${p.link_url}" target="_blank" rel="noopener">ë”ë³´ê¸°</a>` : `<button class="more-btn" type="button" disabled>ë”ë³´ê¸°</button>`}
                    </div>
                  </div>
                </div>`;
              list.appendChild(item);
            }
          } catch (e) {
            console.error(e);
            alert("ì£¼ë³€ ì¥ì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
          }
        }

        btn.addEventListener('click', refreshNearby);
      })();
    </script>
  </body>
</html>
