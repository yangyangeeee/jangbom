<!DOCTYPE html>
<html>
<head>
    <title>ì¥ë³´ê¸° ì„±ê³µ!</title>
</head>
<body>
    <!--ìƒë‹¨ë°”-->
<a href="javascript:history.back()">â—</a>
<a href="{% url 'food:cart_view' %}">ğŸ§º
    {% if cart_items_count == 0 %}
        {% else %}
            {{ cart_items_count }}
        {% endif %}
    </a>
    ë°”ì½”ë“œ
    {{ total_point }}P

  <!-- ì ë¦½ ì•ˆë‚´ -->
<div>
  {% if message %}
    <h2>{{ message }}</h2>
  {% else %}
    <h2>{{ point_earned }} í¬ì¸íŠ¸ ì ë¦½!</h2>
  {% endif %}
    <p>ëˆ„ì  í¬ì¸íŠ¸ {{ total_point }} P</p>
    <p>ëˆ„ì  ê±¸ìŒ ì‹œê°„ {{ total_steps }} </p>
</div>

  <a href="{% url 'point:point_history' %}">ì ë¦½ë‚´ì—­ ></a>
  <a href="{% url 'point:point_ranking' %}">ë­í‚¹í™•ì¸ ></a>

<br><br><hr>

<!-- ì£¼ë³€ ì¥ì†Œ -->
<div>
  <div>
    <h3>ì£¼ë³€ì— ì´ëŸ° ì¥ì†Œë„ ìˆì–´ìš”</h3>
    <button type="button" id="nearby-refresh" aria-label="ë‹¤ì‹œ ë½‘ê¸°">â†»</button>
  </div>

  <div id="nearby-empty" {% if nearby_places %}hidden{% endif %}>
    ë“±ë¡ëœ ì£¼ë³€ ì¥ì†Œê°€ ì—†ì–´ìš”.
  </div>

  <ul id="nearby-list">
    {% for p in nearby_places %}
    <li>
      {% if p.image %}
        <img src="{{ p.image.url }}" alt="{{ p.name }}" width="64" height="64">
      {% else %}
        <div class="thumb" aria-hidden="true"></div>
      {% endif %}
      <div>
        <div>
          <strong>{{ p.name }}</strong>
          {% if p.category %}<span class="pill">{{ p.category }}</span>{% endif %}
        </div>
        <div>{{ p.info }}</div>
        <small>
          ì˜ì—…ì¤‘ Â· {{ p.distance_m }}m
        </small>
        {% if p.link_url %}<div><a href="{{ p.link_url }}" target="_blank">ë”ë³´ê¸°</a></div>{% endif %}
      </div>
    </li>
    {% endfor %}
  </ul>
</div>

    <br><hr><br>
    <a href="{% url 'food:main' %}">í™ˆ</a> |
    <a href="{% url 'accounts:activity_log' %}">ë‚´ í™œë™</a> |
    <a href="{% url 'point:point_home' %}">í¬ì¸íŠ¸</a>

  <!-- AJAX ìƒˆë¡œê³ ì¹¨: ì˜ì—…ì¤‘ ëœë¤ 3ê°œ -->
<script>
  document.getElementById('nearby-refresh')?.addEventListener('click', async function () {
    try {
      const res = await fetch("{% url 'market:nearby_random' market.id %}");
      if (!res.ok) {
        const text = await res.text();
        console.error("HTTP", res.status, text);
        alert("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: " + res.status);
        return;
      }

      const data = await res.json();
      const ul = document.getElementById('nearby-list');
      const empty = document.getElementById('nearby-empty');
      ul.innerHTML = "";

      if (!data.ok || data.items.length === 0) {
        empty.hidden = false; 
        return;
      }
      empty.hidden = true;       // ìˆ¨ê¸°ê¸°

      for (const p of data.items) {
        const li = document.createElement('li');
        li.className = 'place';
        li.innerHTML = `
          ${p.image_url
            ? `<img src="${p.image_url}" alt="${p.name}" width="64" height="64">`
            : `<div class="thumb" aria-hidden="true"></div>`}
          <div class="meta">
            <div class="title-row">
              <strong>${p.name}</strong>
              ${p.category ? ` <span class="pill">${p.category}</span>` : ""}
            </div>
            <div class="info">${p.info || ""}</div>
            <small>ì˜ì—…ì¤‘ Â· ${p.distance_m}m${p.closing_in_minutes ? ` Â· ${p.closing_in_minutes}ë¶„ ë‚¨ìŒ` : ""}</small>
            ${p.link_url ? `<div><a href="${p.link_url}" target="_blank" rel="noopener">ë”ë³´ê¸°</a></div>` : ""}
          </div>`;
        ul.appendChild(li);
      }
    } catch (e) {
      console.error(e);
      alert("ì£¼ë³€ ì¥ì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    }
  });
</script>
</body>
</html>